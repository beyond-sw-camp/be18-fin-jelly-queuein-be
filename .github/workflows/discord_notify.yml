name: Discord Notifications

on:
  issues:
    types: [ opened ]
  pull_request:
    types: [ opened, closed ]
  push:
    branches:
      - develop
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      EVENT: ${{ github.event_name }}
      ACTOR: ${{ github.actor }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_URL: ${{ github.event.issue.html_url }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BRANCH: ${{ github.head_ref }}
      PR_URL: ${{ github.event.pull_request.html_url }}
      PR_MERGED: ${{ github.event.pull_request.merged }}
      BASE_BRANCH: ${{ github.base_ref }}
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      COMMIT_URL: ${{ github.event.head_commit.url }}
      BRANCH: ${{ github.ref_name }}

    steps:
      - name: Send Discord Notification
        run: |
          echo "Triggered event: $EVENT"

          COMMIT_MESSAGE=${COMMIT_MESSAGE:-"(no commit message)"}
          COMMIT_URL=${COMMIT_URL:-""}
          PR_BRANCH=${PR_BRANCH:-"(unknown branch)"}
          BASE_BRANCH=${BASE_BRANCH:-"(unknown base)"}

          # Issue open
          if [ "$EVENT" = "issues" ]; then
            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --arg embeds "[{
                \"title\": \"üìù New Issue Created\",
                \"description\": \"**$ISSUE_TITLE**\",
                \"url\": \"$ISSUE_URL\",
                \"color\": 3447003,
                \"author\": {\"name\": \"$ACTOR\"}
              }]" \
              '{username: $username, embeds: ($embeds | fromjson)}')

          # PR open, merge
          elif [ "$EVENT" = "pull_request" ]; then
            if [ "$PR_MERGED" = "true" ]; then
              JSON=$(jq -n \
                --arg username "GitHub Actions" \
                --arg embeds "[{
                  \"title\": \"‚úÖ Pull Request Merged\",
                  \"description\": \"**$PR_TITLE**\\nMerged into \`$BASE_BRANCH\` by $ACTOR\",
                  \"url\": \"$PR_URL\",
                  \"color\": 3066993,
                  \"author\": {\"name\": \"$ACTOR\"}
                }]" \
                '{username: $username, embeds: ($embeds | fromjson)}')
            else
              JSON=$(jq -n \
                --arg username "GitHub Actions" \
                --arg embeds "[{
                  \"title\": \"üîÄ Pull Request Opened\",
                  \"description\": \"PR: **$PR_TITLE**\\nBranch: \`$PR_BRANCH\`\",
                  \"url\": \"$PR_URL\",
                  \"color\": 15105570,
                  \"author\": {\"name\": \"$ACTOR\"}
                }]" \
                '{username: $username, embeds: ($embeds | fromjson)}')
            fi

          # push
          elif [ "$EVENT" = "push" ]; then
            # squash / merge commit Î©îÏãúÏßÄ ÌôïÏù∏ ÌõÑ skip
            if echo "$COMMIT_MESSAGE" | grep -qiE "^Merge pull request|^Merge branch"; then
              echo "üü° Skipping push notification for merge/squash commit."
              exit 0
            fi

            # Ï§ÑÎ∞îÍøà Ìè¨Ìï® Î©îÏãúÏßÄ ÏïàÏ†ÑÌïòÍ≤å escape Ï≤òÎ¶¨
            SANITIZED_COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | jq -Rs . | sed 's/^"//;s/"$//')

            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --arg branch "$BRANCH" \
              --arg commit_message "$SANITIZED_COMMIT_MESSAGE" \
              --arg url "$COMMIT_URL" \
              --arg actor "$ACTOR" \
              '{
                username: $username,
                embeds: [{
                  title: "üöÄ New Commit on " + $branch,
                  description: $commit_message,
                  url: $url,
                  color: 5814783,
                  author: { name: $actor }
                }]
              }')
          fi

          # Send Discord message
          
          if [ -n "$JSON" ]; then
            curl -H "Content-Type: application/json" \
                 -d "$JSON" \
                 "$DISCORD_WEBHOOK_URL"
          fi
