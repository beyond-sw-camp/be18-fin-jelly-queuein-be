name: Discord Notifications

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, closed]
  push:
    branches:
      - develop
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      EVENT: ${{ github.event_name }}
      ACTOR: ${{ github.actor }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_URL: ${{ github.event.issue.html_url }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BRANCH: ${{ github.head_ref }}
      PR_URL: ${{ github.event.pull_request.html_url }}
      PR_MERGED: ${{ github.event.pull_request.merged }}
      BASE_BRANCH: ${{ github.base_ref }}
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      COMMIT_URL: ${{ github.event.head_commit.url }}
      BRANCH: ${{ github.ref_name }}

    steps:
      - name: Send Discord Notification
        run: |
          echo "Triggered event: $EVENT"

          COMMIT_MESSAGE=${COMMIT_MESSAGE:-"(no commit message)"}
          COMMIT_URL=${COMMIT_URL:-""}
          PR_BRANCH=${PR_BRANCH:-"(unknown branch)"}
          BASE_BRANCH=${BASE_BRANCH:-"(unknown base)"}

          # === ISSUE OPEN ===
          if [ "$EVENT" = "issues" ]; then
            SANITIZED_ISSUE_TITLE=$(printf "%b" "$ISSUE_TITLE" | sed 's/^/‚Ä¢ /' | sed 's/\n/\n‚Ä¢ /g')
            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --arg title "üìù New Issue Created" \
              --arg desc "$SANITIZED_ISSUE_TITLE" \
              --arg url "$ISSUE_URL" \
              --arg actor "$ACTOR" \
              '{
                username: $username,
                embeds: [{
                  title: $title,
                  description: $desc,
                  url: $url,
                  color: 3447003,
                  author: { name: $actor }
                }]
              }')

          # === PR OPEN / MERGE ===
          elif [ "$EVENT" = "pull_request" ]; then
            SANITIZED_PR_TITLE=$(printf "%b" "$PR_TITLE" | sed 's/^/‚Ä¢ /' | sed 's/\n/\n‚Ä¢ /g')

            if [ "$PR_MERGED" = "true" ]; then
              SANITIZED_DESC=$(printf "%b" "**$PR_TITLE**\nMerged into \`$BASE_BRANCH\` by $ACTOR" | sed 's/^/‚Ä¢ /' | sed 's/\n/\n‚Ä¢ /g')
              JSON=$(jq -n \
                --arg username "GitHub Actions" \
                --arg title "‚úÖ Pull Request Merged" \
                --arg desc "$SANITIZED_DESC" \
                --arg url "$PR_URL" \
                --arg actor "$ACTOR" \
                '{
                  username: $username,
                  embeds: [{
                    title: $title,
                    description: $desc,
                    url: $url,
                    color: 3066993,
                    author: { name: $actor }
                  }]
                }')
            else
              SANITIZED_DESC=$(printf "%b" "PR: **$PR_TITLE**\nBranch: \`$PR_BRANCH\`" | sed 's/^/‚Ä¢ /' | sed 's/\n/\n‚Ä¢ /g')
              JSON=$(jq -n \
                --arg username "GitHub Actions" \
                --arg title "üîÄ Pull Request Opened" \
                --arg desc "$SANITIZED_DESC" \
                --arg url "$PR_URL" \
                --arg actor "$ACTOR" \
                '{
                  username: $username,
                  embeds: [{
                    title: $title,
                    description: $desc,
                    url: $url,
                    color: 15105570,
                    author: { name: $actor }
                  }]
                }')
            fi

          # === PUSH EVENT ===
          elif [ "$EVENT" = "push" ]; then
            # squash / merge commit Î©îÏãúÏßÄ ÌôïÏù∏ ÌõÑ skip
            if echo "$COMMIT_MESSAGE" | grep -qiE "^Merge pull request|^Merge branch|[(]#[0-9]+[)]$"; then
              echo "üü° Skipping push notification for merge/squash commit."
              exit 0
            fi

            # Ïã§Ï†ú Ï§ÑÎ∞îÍøà Ï†ÅÏö© + Í∞Å Ï§Ñ ÏïûÏóê ‚Ä¢ Ï∂îÍ∞Ä
            SANITIZED_COMMIT_MESSAGE=$(printf "%b" "$COMMIT_MESSAGE" | sed 's/^/‚Ä¢ /' | sed 's/\n/\n‚Ä¢ /g')

            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --arg branch "$BRANCH" \
              --arg commit_message "$SANITIZED_COMMIT_MESSAGE" \
              --arg url "$COMMIT_URL" \
              --arg actor "$ACTOR" \
              '{
                username: $username,
                embeds: [{
                  title: "üöÄ New Commit on \($branch)",
                  description: $commit_message,
                  url: $url,
                  color: 5814783,
                  author: { name: $actor }
                }]
              }')
          fi


          # === SEND DISCORD MESSAGE ===
          if [ -n "$JSON" ]; then
            echo "Sending message to Discord..."
            curl -H "Content-Type: application/json" \
                 -d "$JSON" \
                 "$DISCORD_WEBHOOK_URL"
          fi
