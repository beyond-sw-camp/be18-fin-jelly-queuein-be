name: Discord Notifications

on:
  issues:
    types: [ opened ]
  pull_request:
    types: [ opened ]
  push:
    branches:
      - develop
      - main
      - feature/41-workflow-bug

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      EVENT: ${{ github.event_name }}
      ACTOR: ${{ github.actor }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_URL: ${{ github.event.issue.html_url }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BRANCH: ${{ github.head_ref }}
      PR_URL: ${{ github.event.pull_request.html_url }}
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      COMMIT_URL: ${{ github.event.head_commit.url }}
      BRANCH: ${{ github.ref_name }}
    steps:
      - name: Send Discord Notification
        run: |
          echo "Triggered event: $EVENT"

          if [ "$EVENT" = "issues" ]; then
            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --argjson embeds "[{
                \"title\": \"üìù New Issue Created\",
                \"description\": \"**$ISSUE_TITLE**\",
                \"url\": \"$ISSUE_URL\",
                \"color\": 3447003,
                \"author\": {\"name\": \"$ACTOR\"}
              }]" \
              '{username: $username, embeds: $embeds}')

          elif [ "$EVENT" = "pull_request" ]; then
            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --argjson embeds "[{
                \"title\": \"üîÄ Pull Request Opened\",
                \"description\": \"PR: **$PR_TITLE**\\nBranch: \`$PR_BRANCH\`\",
                \"url\": \"$PR_URL\",
                \"color\": 15105570,
                \"author\": {\"name\": \"$ACTOR\"}
              }]" \
              '{username: $username, embeds: $embeds}')

          elif [ "$EVENT" = "push" ]; then
            JSON=$(jq -n \
              --arg username "GitHub Actions" \
              --argjson embeds "[{
                \"title\": \"üöÄ New Commit on $BRANCH\",
                \"description\": \"$COMMIT_MESSAGE\",
                \"url\": \"$COMMIT_URL\",
                \"color\": 5814783,
                \"author\": {\"name\": \"$ACTOR\"}
              }]" \
              '{username: $username, embeds: $embeds}')
          fi

          curl -H "Content-Type: application/json" \
               -d "$JSON" \
               "$DISCORD_WEBHOOK_URL"
