pipeline {
	agent any

	environment {
		DOPPLER_TOKEN = credentials('DOPPLER_TOKEN')
	}

	stages {
		stage('docker-compose ì„¤ì¹˜ í™•ì¸') {
			steps {
				echo 'docker-compose ì„¤ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤...'
				sh '''
                if command -v docker-compose >/dev/null 2>&1; then
                    echo "âœ… docker-composeê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                    docker-compose version
                else
                    echo "âš ï¸ docker-compose ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                    echo "Jenkins Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œ docker-composeë¥¼ ë¯¸ë¦¬ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤."
                    exit 1
                fi
                '''
			}
		}

		stage('Doppler CLI ì„¤ì¹˜ í™•ì¸') {
			steps {
				echo 'Doppler CLI ì„¤ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤...'
				sh '''
                if ! command -v doppler >/dev/null 2>&1; then
                    echo "ğŸš€ doppler CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
                    curl -Ls https://cli.doppler.com/install.sh | sh
                    echo "âœ… doppler CLI ì„¤ì¹˜ ì™„ë£Œ"
                else
                    echo "âœ… doppler CLIê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                fi
                doppler --version
                '''
			}
		}

		stage('Fetch Environment') {
			steps {
				echo "ğŸ”§ Setting up Doppler..."
				sh '''
                doppler setup --token $DOPPLER_TOKEN --no-interactive
                '''
			}
		}

		stage('Build with Doppler Envs') {
			steps {
				echo "ğŸ—ï¸ Running Gradle build with Doppler envs"
				sh '''
                cd qiin-be
                doppler run --command "./gradlew clean build -x test"
                '''
			}
		}

		stage('Archive Build') {
			steps {
				archiveArtifacts artifacts: 'qiin-be/build/libs/*.jar', fingerprint: true
			}
		}

		stage('Deploy with Docker Compose') {
			steps {
				echo "ğŸš€ Starting deployment via Docker Compose..."
				sh '''
                cd qiin-be

                echo "ğŸ§¹ Stopping previous containers..."
                docker-compose down || true

                echo "ğŸ³ Building and starting new containers..."
                doppler run -- bash -c "docker-compose up -d --build"

                echo "âœ… Deployment completed successfully!"
                '''
			}
		}
	}

}
